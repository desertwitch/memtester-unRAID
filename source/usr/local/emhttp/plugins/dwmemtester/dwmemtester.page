Menu="Utilities"
Type="xmenu"
Title="Memory Tester"
Icon="microchip"
Tag="microchip"
Markdown="false"
---
<?
$memlaststart = trim(file_exists("/var/lib/memtester/laststart") ? htmlspecialchars(file_get_contents("/var/lib/memtester/laststart")) : "-");
$memlastfinish = trim(file_exists("/var/lib/memtester/lastfinish") ? htmlspecialchars(file_get_contents("/var/lib/memtester/lastfinish")) : "-");
$memlog_size = trim(file_exists("/var/lib/memtester/log") ? htmlspecialchars(filesize("/var/lib/memtester/log")) : "-");
$errlog_size = trim(file_exists("/var/lib/memtester/errlog") ? htmlspecialchars(filesize("/var/lib/memtester/errlog")) : "-");
?>

<style type="text/css">
.memlog {
    height: 450px;
    max-height: 450px;
    width: 100%;
    max-width: 100%;
    overflow: auto;
    word-break: normal !important;
    word-wrap: normal !important;
    white-space: pre !important;
}
.errlog {
    height: 450px;
    max-height: 450px;
    width: 100%;
    max-width: 100%;
    overflow: auto;
    word-break: normal !important;
    word-wrap: normal !important;
    white-space: pre !important;
}
.logtable {
    table-layout: fixed;
}
</style>

<table class="tablesorter shift logtable" autofocus>
<thead>
<tr>
<th><i id="memstatusicon" class="fa fa-cog fa-spin" style="display:none;"></i> <strong>Operation Screen</strong></th>
<th style="text-transform: none;"><span style="float:right;"><strong>Started:</strong> <em><?=$memlaststart?></em></span></th>
<th style="text-transform: none;"><strong>Finished:</strong> <em><?=$memlastfinish?></em></th>
<th style="text-transform: none;"><span style="float:right;"><strong>Refresh:</strong> <i id="memlogcontrol" class="fa fa-refresh fa-spin"></i></span></th>
</tr>
<tr>
<th><strong>REGULAR OUTPUT (STDOUT)</strong></th>
<th style="text-transform: none;"><span style="float:right;"><strong>File Size:</strong> <?=$memlog_size;?> bytes</span></th>
<th><strong>ERROR OUTPUT (STDERR)</strong></th>
<th style="text-transform: none;"><span style="float:right;"><strong>File Size:</strong> <?=$errlog_size;?> bytes</span></th>
</tr>
<tbody>
<tr>
<td colspan="2"><span id="memlogviewer"><div style="text-align:center;"><i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em></div></span></td>
<td colspan="2"><span id="errlogviewer"><div style="text-align:center;"><i class="fa fa-spinner fa-spin"></i> <em>Please wait, retrieving information...</em></div></span></td>
</tr>
</tbody>
</table>

<form markdown="0" id="memcommands" name="memcommands" method="POST" action="/update.php" target="progressFrame">
    <input type="hidden" id="memcommand" name="#command" value="/usr/local/emhttp/plugins/dwmemtester/scripts/start">
    <input type="hidden" id="arg1" name="#arg[1]" value="0">
    <input type="hidden" id="arg2" name="#arg[2]" value="">
    <input type="hidden" id="arg3" name="#arg[3]" value="">
    <input type="hidden" id="arg4" name="#arg[4]" value="">
    <input type="hidden" id="arg4" name="#arg[5]" value="">

    <input type="text" class="narrow memrun" id="memsize" name="#arg[5]" placeholder="<memory>[B|K|M|G]" value="">
    <input type="text" class="narrow memrun" id="memloops" name="#arg[6]" placeholder="(optional) loops" value="">
    <input type="button" class="memrun" id="memstart" value="Start Operation">
    <input type="text" class="memrun" id="memhex" placeholder="(optional) hex starting point" value="">
    <input type="text" class="memrun" id="memtarget" placeholder="(optional) target device" value="">

    <input type="checkbox" id="memerrs" value="memerrs">
    <label for="memerrs">Write Detailed Errors (Not Recommended)</label>    

    <span style="float:right;">
        <input type="button" class="memrun" id="memclear" value="Clear Logs">
        <input type="button" class="memnotrun" id="memstop" value="Stop Operation">
        <input type="button" class="memnotrun" id="memkill" value="Kill Operation">
    </span><br>

</form>

<script type="text/javascript">
function getMemLogs() {
    $.get('/plugins/dwmemtester/include/dwmemtester_log.php', function(data) {
        if (data) { 
            $('#memlogviewer').html(data); 
	        var pre = $(".memlog");
	        pre.scrollTop(pre.prop("scrollHeight"));
	    }
    });
    clearTimeout(timers.getMemLogs);
    timers.getMemLogs = setTimeout(getMemLogs, 1000);
}
function getErrLogs() {
    $.get('/plugins/dwmemtester/include/dwmemtester_errlog.php', function(data) {
        if (data) { 
            $('#errlogviewer').html(data); 
	        var pre2 = $(".errlog");
	        pre2.scrollTop(pre2.prop("scrollHeight"));
	    }
    });
    clearTimeout(timers.getErrLogs);
    timers.getErrLogs = setTimeout(getErrLogs, 1000);
}
function getMemStatus() {
    $.get('/plugins/dwmemtester/include/dwmemtester_status.php', function(data) {
        if (data) {
            if(data === "RUNNING:YES") {
                $('#memstatusicon').show();
                $('.memrun').prop('disabled', true);
                $('.memnotrun').prop('disabled', false);
            } else if (data === "RUNNING:NO") {
                if($('#memstatusicon').is(":visible")) {
                    location = '/Settings/dwmemtester';
                }
                $('#memstatusicon').hide();
                $('.memrun').prop('disabled', false);
                $('.memnotrun').prop('disabled', true);
                $('#memlogcontrol').attr("class", "fa fa-refresh");
                clearTimeout(timers.getMemLogs);
                clearTimeout(timers.getErrLogs);
            }
	    }
    });
    clearTimeout(timers.getMemStatus);
    timers.getMemStatus = setTimeout(getMemStatus, 3000);
}
function toggleMemLogs() {
    if($('#memlogcontrol').attr("class") == "fa fa-refresh fa-spin") {
        $('#memlogcontrol').attr("class", "fa fa-refresh");
        clearTimeout(timers.getMemLogs);
        clearTimeout(timers.getErrLogs);
    } else {
        $('#memlogcontrol').attr("class", "fa fa-refresh fa-spin");
        getMemLogs();
        getErrLogs();
    }
}
$(function()
{
    $('#memstart').click(function(){
        $('#memcommand').val('/usr/local/emhttp/plugins/dwmemtester/scripts/start');
        if($('#memerrs').is(':checked')) {
            $('#arg1').val('1');
        }
        if($('#memhex').val()) {
            $('#arg2').val('-p');
            $('#arg3').val($('#memhex').val());
        }
        if($('#memtarget').val()) {
            $('#arg4').val('-d');
            $('#arg5').val($('#memtarget').val());
        }
        $('#memcommands').submit();
    });
    $('#memclear').click(function(){
        $('#memcommand').val('/usr/local/emhttp/plugins/dwmemtester/scripts/clear');
        $('#memcommands').submit();
    });
    $('#memstop').click(function(){
        $('#memcommand').val('/usr/local/emhttp/plugins/dwmemtester/scripts/stop');
        $('#memcommands').submit();
    });
    $('#memkill').click(function(){
        $('#memcommand').val('/usr/local/emhttp/plugins/dwmemtester/scripts/kill');
        $('#memcommands').submit();
    });
    $('#memlogcontrol').click(toggleMemLogs);
    getMemStatus()
    getMemLogs();
    getErrLogs();
});
</script>
