#!/bin/bash

# shellcheck disable=SC2317
signal_exit_memtest() {
    printf "\nThe operation was interrupted by a SIGTERM or SIGINT that was received." | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
    date +"%d.%m.%Y %H:%M:%S %Z" > /var/lib/memtester/lastfinish
    exit 1
}

params=("$@")

[ ! -d /var/lib/memtester ] && mkdir -p /var/lib/memtester

rm -f /var/lib/memtester/laststart
rm -f /var/lib/memtester/lastfinish

STARTDATE="$(date +"%d.%m.%Y %H:%M:%S %Z")"
echo "$STARTDATE" > /var/lib/memtester/laststart

trap signal_exit_memtest SIGTERM SIGINT 

echo "[${STARTDATE}] /usr/bin/memtester ${params[*]:1}" | tee /var/lib/memtester/log /var/lib/memtester/errlog
echo "=============================================================================================" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
echo "" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog

if [ "${params[0]}" == "1" ]; then
    echo "The detailed error output was enabled, please watch this panel for any occuring errors." | tee -a /var/lib/memtester/errlog
    echo "" | tee -a /var/lib/memtester/errlog
    /usr/bin/memtester "${params[@]:1}" 1>>/var/lib/memtester/log 2>>/var/lib/memtester/errlog
    CMDRET=${PIPESTATUS[0]}
else
    echo "The detailed error output was disabled, please refer to the left panel for the test summary." | tee -a /var/lib/memtester/errlog
    echo "" | tee -a /var/lib/memtester/errlog
    /usr/bin/memtester "${params[@]:1}" 1>>/var/lib/memtester/log 2>/dev/null
    CMDRET=${PIPESTATUS[0]}
fi

echo "=============================================================================================" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog

ENDDATE="$(date +"%d.%m.%Y %H:%M:%S %Z")"
echo "$ENDDATE" > /var/lib/memtester/lastfinish

if [ "$CMDRET" -eq 0 ]; then
    printf "[%s] The operation has finished without errors.\n[%s] Return Code: %s - OK." "${ENDDATE}" "${ENDDATE}" "${CMDRET}" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
elif [ "$CMDRET" -eq 1 ]; then
    printf "[%s] The operation has finished with errors.\n[%s] Return Code: %s - Program Invocation or Memory Allocation Error." "${ENDDATE}" "${ENDDATE}" "${CMDRET}" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
elif [ "$CMDRET" -eq 2 ]; then
    printf "[%s] The operation has finished with errors.\n[%s] Return Code: %s - Error during Stuck Address Test." "${ENDDATE}" "${ENDDATE}" "${CMDRET}" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
elif [ "$CMDRET" -eq 4 ]; then
    printf "[%s] The operation has finished with errors.\n[%s] Return Code: %s - Error during Test(s)." "${ENDDATE}" "${ENDDATE}" "${CMDRET}" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
elif [ "$CMDRET" -eq 6 ]; then
    printf "[%s] The operation has finished with errors.\n[%s] Return Code: %s - Error during Stuck Address Test + Other Test(s)." "${ENDDATE}" "${ENDDATE}" "${CMDRET}" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
else
    printf "[%s] The operation has finished with errors.\n[%s] Return Code: %s - Check Operation Output for Details." "${ENDDATE}" "${ENDDATE}" "${CMDRET}" | tee -a /var/lib/memtester/log /var/lib/memtester/errlog
fi

exit 0
